<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>论文比对工具 | 在线对比两篇论文的差异 | Kopaper</title>
    <meta name="description" content="Kopaper论文比对工具，快速对比两篇论文的差异，支持Word和PDF文件，清晰标记新增和删除内容，免费使用。">
    <meta name="keywords" content="论文比对,论文差异对比,论文修改对比,两篇论文比对,论文比对工具">
    
    <!-- 引入外部资源 -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/diff-match-patch@1.0.5/index.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/mammoth@1.6.0/mammoth.browser.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/pdf-parse@1.1.1/build/pdf-parse.min.js"></script>
    
    <!-- Tailwind配置 -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#2563EB', // 主色调：专业蓝
                        secondary: '#10B981', // 辅助色：成功绿
                        danger: '#EF4444', // 强调色：删除红
                        warning: '#F59E0B', // 警告黄
                        neutral: '#475569', // 中性色：文本灰
                        light: '#F8FAFC', // 浅色背景
                        dark: '#1E293B'  // 深色文本
                    },
                    fontFamily: {
                        sans: ['Inter', 'system-ui', 'sans-serif'],
                    },
                }
            }
        }
    </script>
    
    <style type="text/tailwindcss">
        @layer utilities {
            .content-auto {
                content-visibility: auto;
            }
            .text-shadow {
                text-shadow: 0 1px 2px rgba(0,0,0,0.1);
            }
            .transition-height {
                transition: max-height 0.3s ease-in-out;
            }
            .scrollbar-thin {
                scrollbar-width: thin;
            }
            .scrollbar-thin::-webkit-scrollbar {
                width: 6px;
                height: 6px;
            }
            .scrollbar-thin::-webkit-scrollbar-thumb {
                background-color: rgba(71, 85, 105, 0.5);
                border-radius: 3px;
            }
            .dropzone-active {
                @apply border-primary bg-blue-50;
            }
        }
    </style>
</head>
<body class="bg-light font-sans text-dark min-h-screen flex flex-col">
    <!-- 顶部导航 -->
    <header class="bg-white shadow-sm sticky top-0 z-50 transition-all duration-300" id="navbar">
        <div class="container mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between items-center h-16">
                <!-- Logo -->
                <div class="flex items-center">
                    <a href="/" class="flex items-center space-x-2">
                        <i class="fa fa-file-text-o text-primary text-2xl"></i>
                        <span class="text-xl font-bold text-primary">Kopaper</span>
                    </a>
                </div>
                
                <!-- 桌面导航 -->
                <nav class="hidden md:flex space-x-8">
                    <a href="/" class="text-neutral hover:text-primary transition-colors flex items-center">
                        <i class="fa fa-home mr-1.5"></i>首页
                    </a>
                    <a href="/compare.html" class="text-primary font-medium flex items-center">
                        <i class="fa fa-exchange mr-1.5"></i>论文比对
                    </a>
                    <a href="/check.html" class="text-neutral hover:text-primary transition-colors flex items-center">
                        <i class="fa fa-search mr-1.5"></i>收录查询
                    </a>
                    <a href="/help.html" class="text-neutral hover:text-primary transition-colors flex items-center">
                        <i class="fa fa-question-circle mr-1.5"></i>使用帮助
                    </a>
                </nav>
                
                <!-- 移动端菜单按钮 -->
                <div class="md:hidden">
                    <button id="menu-toggle" class="text-neutral hover:text-primary focus:outline-none">
                        <i class="fa fa-bars text-xl"></i>
                    </button>
                </div>
            </div>
        </div>
        
        <!-- 移动端导航菜单 -->
        <div id="mobile-menu" class="hidden md:hidden bg-white border-t">
            <div class="container mx-auto px-4 py-3 space-y-3">
                <a href="/" class="block py-2 text-neutral hover:text-primary transition-colors">
                    <i class="fa fa-home mr-2"></i>首页
                </a>
                <a href="/compare.html" class="block py-2 text-primary font-medium">
                    <i class="fa fa-exchange mr-2"></i>论文比对
                </a>
                <a href="/check.html" class="block py-2 text-neutral hover:text-primary transition-colors">
                    <i class="fa fa-search mr-2"></i>收录查询
                </a>
                <a href="/help.html" class="block py-2 text-neutral hover:text-primary transition-colors">
                    <i class="fa fa-question-circle mr-2"></i>使用帮助
                </a>
            </div>
        </div>
    </header>

    <!-- 主内容区 -->
    <main class="flex-grow container mx-auto px-4 sm:px-6 lg:px-8 py-8">
        <!-- 页面标题和介绍 -->
        <section class="mb-10">
            <div class="flex flex-col md:flex-row md:items-center md:justify-between">
                <div>
                    <h1 class="text-[clamp(1.5rem,3vw,2.5rem)] font-bold mb-2">论文比对工具</h1>
                    <p class="text-neutral">快速对比两篇论文的差异，清晰展示修改内容，辅助论文修订</p>
                </div>
                <div class="mt-4 md:mt-0">
                    <a href="/help.html#compare" class="inline-flex items-center text-primary hover:text-primary/80 text-sm font-medium transition-colors">
                        <i class="fa fa-question-circle mr-1.5"></i>查看使用帮助
                    </a>
                </div>
            </div>
        </section>

        <!-- 安全提示 -->
        <section class="mb-8">
            <div class="bg-blue-50 border-l-4 border-primary p-4 rounded-r-lg">
                <div class="flex">
                    <div class="flex-shrink-0">
                        <i class="fa fa-lock text-primary"></i>
                    </div>
                    <div class="ml-3">
                        <p class="text-sm text-blue-700">
                            所有比对操作均在您的设备上本地完成，不会上传您的论文内容，保障您的学术成果安全。
                        </p>
                    </div>
                </div>
            </div>
        </section>

        <!-- 比对模式选择 -->
        <section class="mb-8">
            <div class="bg-white rounded-lg shadow-sm overflow-hidden">
                <div class="flex flex-wrap border-b border-gray-200">
                    <button id="fileModeBtn" class="flex-1 px-6 py-4 font-medium text-primary border-b-2 border-primary transition-all">
                        <i class="fa fa-upload mr-2"></i>文件上传
                    </button>
                    <button id="textModeBtn" class="flex-1 px-6 py-4 font-medium text-neutral hover:text-primary transition-all">
                        <i class="fa fa-paste mr-2"></i>文本粘贴
                    </button>
                </div>
            </div>
        </section>

        <!-- 文件上传模式 -->
        <section id="fileMode" class="mb-10">
            <div class="grid md:grid-cols-2 gap-6">
                <!-- 原始版本 -->
                <div class="bg-white rounded-lg shadow-sm p-6 border border-gray-200 transform hover:shadow-md transition-all">
                    <h3 class="text-lg font-semibold mb-4 flex items-center">
                        <span class="w-2 h-2 rounded-full bg-neutral mr-2"></span>
                        原始版本
                    </h3>
                    <div id="fileDropzone1" class="border-2 border-dashed border-gray-300 rounded-lg p-8 text-center hover:border-primary transition-colors cursor-pointer min-h-[200px] flex flex-col items-center justify-center">
                        <i class="fa fa-file-word-o text-4xl text-neutral mb-3"></i>
                        <p class="mb-2 text-neutral">拖放文件到此处，或<span class="text-primary font-medium">点击上传</span></p>
                        <p class="text-xs text-gray-400">支持 .docx 或 .pdf 格式（最大20MB）</p>
                        <input type="file" id="fileInput1" class="hidden" accept=".docx,.pdf">
                    </div>
                    <div id="fileInfo1" class="mt-4 hidden">
                        <div class="flex items-center justify-between p-3 bg-light rounded-lg border border-gray-200">
                            <div class="flex items-center overflow-hidden">
                                <i class="fa fa-file-text-o text-primary mr-3 flex-shrink-0"></i>
                                <span id="fileName1" class="truncate"></span>
                            </div>
                            <button id="removeFile1" class="text-neutral hover:text-danger transition-colors p-1">
                                <i class="fa fa-times"></i>
                            </button>
                        </div>
                    </div>
                </div>

                <!-- 修改版本 -->
                <div class="bg-white rounded-lg shadow-sm p-6 border border-gray-200 transform hover:shadow-md transition-all">
                    <h3 class="text-lg font-semibold mb-4 flex items-center">
                        <span class="w-2 h-2 rounded-full bg-primary mr-2"></span>
                        修改版本
                    </h3>
                    <div id="fileDropzone2" class="border-2 border-dashed border-gray-300 rounded-lg p-8 text-center hover:border-primary transition-colors cursor-pointer min-h-[200px] flex flex-col items-center justify-center">
                        <i class="fa fa-file-word-o text-4xl text-neutral mb-3"></i>
                        <p class="mb-2 text-neutral">拖放文件到此处，或<span class="text-primary font-medium">点击上传</span></p>
                        <p class="text-xs text-gray-400">支持 .docx 或 .pdf 格式（最大20MB）</p>
                        <input type="file" id="fileInput2" class="hidden" accept=".docx,.pdf">
                    </div>
                    <div id="fileInfo2" class="mt-4 hidden">
                        <div class="flex items-center justify-between p-3 bg-light rounded-lg border border-gray-200">
                            <div class="flex items-center overflow-hidden">
                                <i class="fa fa-file-text-o text-primary mr-3 flex-shrink-0"></i>
                                <span id="fileName2" class="truncate"></span>
                            </div>
                            <button id="removeFile2" class="text-neutral hover:text-danger transition-colors p-1">
                                <i class="fa fa-times"></i>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- 文本粘贴模式 -->
        <section id="textMode" class="mb-10 hidden">
            <div class="grid md:grid-cols-2 gap-6">
                <!-- 原始版本 -->
                <div class="bg-white rounded-lg shadow-sm p-6 border border-gray-200 transform hover:shadow-md transition-all">
                    <h3 class="text-lg font-semibold mb-4 flex items-center">
                        <span class="w-2 h-2 rounded-full bg-neutral mr-2"></span>
                        原始版本
                    </h3>
                    <div>
                        <textarea id="originalText" rows="12" class="w-full p-4 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary/30 focus:border-primary outline-none transition-all resize-none scrollbar-thin" placeholder="粘贴原始论文内容..."></textarea>
                    </div>
                </div>

                <!-- 修改版本 -->
                <div class="bg-white rounded-lg shadow-sm p-6 border border-gray-200 transform hover:shadow-md transition-all">
                    <h3 class="text-lg font-semibold mb-4 flex items-center">
                        <span class="w-2 h-2 rounded-full bg-primary mr-2"></span>
                        修改版本
                    </h3>
                    <div>
                        <textarea id="modifiedText" rows="12" class="w-full p-4 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary/30 focus:border-primary outline-none transition-all resize-none scrollbar-thin" placeholder="粘贴修改后的论文内容..."></textarea>
                    </div>
                </div>
            </div>
        </section>

        <!-- 比对按钮 -->
        <section class="text-center mb-10">
            <button id="compareBtn" class="px-8 py-3 bg-primary hover:bg-primary/90 text-white rounded-lg font-medium shadow-md hover:shadow-lg transition-all disabled:opacity-50 disabled:cursor-not-allowed disabled:hover:shadow-md">
                <i class="fa fa-exchange mr-2"></i>开始比对
            </button>
        </section>

        <!-- 加载状态 -->
        <section id="loadingSection" class="text-center mb-10 hidden">
            <div class="flex flex-col items-center p-8 bg-white rounded-lg shadow-sm">
                <div class="w-12 h-12 border-4 border-gray-200 border-t-primary rounded-full animate-spin mb-4"></div>
                <p class="text-neutral">正在比对中，请稍候...</p>
                <p class="text-sm text-gray-500 mt-2">文件较大时可能需要更长时间</p>
            </div>
        </section>

        <!-- 比对结果 -->
        <section id="resultSection" class="mb-10 hidden">
            <!-- 结果统计 -->
            <div class="bg-white rounded-lg shadow-sm p-6 mb-6 border border-gray-200">
                <h3 class="text-lg font-semibold mb-6 flex items-center">
                    <i class="fa fa-bar-chart text-primary mr-2"></i>比对结果统计
                </h3>
                <div class="grid grid-cols-2 md:grid-cols-4 gap-4 md:gap-6">
                    <div class="bg-light p-4 rounded-lg text-center border border-gray-200 transform hover:shadow-sm transition-all">
                        <p class="text-neutral text-sm mb-1">相似度</p>
                        <p id="similarityScore" class="text-2xl font-bold text-primary">0%</p>
                    </div>
                    <div class="bg-light p-4 rounded-lg text-center border border-gray-200 transform hover:shadow-sm transition-all">
                        <p class="text-neutral text-sm mb-1">总字数</p>
                        <p id="totalWords" class="text-2xl font-bold text-primary">0</p>
                    </div>
                    <div class="bg-light p-4 rounded-lg text-center border border-gray-200 transform hover:shadow-sm transition-all">
                        <p class="text-neutral text-sm mb-1">新增内容</p>
                        <p id="addedCount" class="text-2xl font-bold text-secondary">0</p>
                    </div>
                    <div class="bg-light p-4 rounded-lg text-center border border-gray-200 transform hover:shadow-sm transition-all">
                        <p class="text-neutral text-sm mb-1">删除内容</p>
                        <p id="deletedCount" class="text-2xl font-bold text-danger">0</p>
                    </div>
                </div>
                <div class="mt-6 flex flex-wrap gap-3">
                    <button id="collapseBtn" class="px-4 py-2 bg-light hover:bg-gray-200 text-neutral rounded-lg text-sm flex items-center transition-colors border border-gray-200">
                        <i class="fa fa-compress mr-2"></i>折叠无差异内容
                    </button>
                    <button id="expandBtn" class="px-4 py-2 bg-light hover:bg-gray-200 text-neutral rounded-lg text-sm flex items-center transition-colors border border-gray-200 hidden">
                        <i class="fa fa-expand mr-2"></i>展开所有内容
                    </button>
                    <button id="exportBtn" class="px-4 py-2 bg-light hover:bg-gray-200 text-neutral rounded-lg text-sm flex items-center transition-colors border border-gray-200">
                        <i class="fa fa-download mr-2"></i>导出比对报告
                    </button>
                    <button id="restartBtn" class="px-4 py-2 bg-light hover:bg-gray-200 text-neutral rounded-lg text-sm flex items-center transition-colors border border-gray-200">
                        <i class="fa fa-refresh mr-2"></i>重新比对
                    </button>
                </div>
            </div>

            <!-- 比对内容 -->
            <div class="bg-white rounded-lg shadow-sm border border-gray-200 overflow-hidden">
                <div class="grid grid-cols-1 md:grid-cols-2 border-b border-gray-200">
                    <div class="p-4 bg-light font-medium flex items-center">
                        <span class="w-2 h-2 rounded-full bg-neutral mr-2"></span>
                        原始版本
                    </div>
                    <div class="p-4 bg-primary/5 font-medium text-primary flex items-center">
                        <span class="w-2 h-2 rounded-full bg-primary mr-2"></span>
                        修改版本
                    </div>
                </div>
                <div id="comparisonContent" class="grid grid-cols-1 md:grid-cols-2">
                    <div id="originalContent" class="p-6 border-r border-gray-200 max-h-[600px] overflow-y-auto scrollbar-thin"></div>
                    <div id="modifiedContent" class="p-6 max-h-[600px] overflow-y-auto scrollbar-thin"></div>
                </div>
            </div>
        </section>

        <!-- 帮助提示 -->
        <section class="bg-white rounded-lg shadow-sm p-6 mb-10 border border-gray-200">
            <h3 class="text-lg font-semibold mb-4 flex items-center">
                <i class="fa fa-lightbulb-o text-warning mr-2"></i>使用提示
            </h3>
            <ul class="space-y-3 text-neutral">
                <li class="flex items-start">
                    <i class="fa fa-check-circle text-secondary mt-1 mr-3"></i>
                    <span>绿色高亮部分表示新增内容，红色删除线部分表示删除内容</span>
                </li>
                <li class="flex items-start">
                    <i class="fa fa-check-circle text-secondary mt-1 mr-3"></i>
                    <span>相似度仅供参考，不代表学术查重结果</span>
                </li>
                <li class="flex items-start">
                    <i class="fa fa-check-circle text-secondary mt-1 mr-3"></i>
                    <span>复杂格式（如公式、图表）可能影响比对精度，建议先转为纯文本</span>
                </li>
                <li class="flex items-start">
                    <i class="fa fa-check-circle text-secondary mt-1 mr-3"></i>
                    <span>所有操作均在本地完成，确保您的论文内容安全</span>
                </li>
            </ul>
        </section>
    </main>

    <!-- 页脚 -->
    <footer class="bg-dark text-gray-400 py-12">
        <div class="container mx-auto px-4 sm:px-6 lg:px-8">
            <div class="grid grid-cols-1 md:grid-cols-4 gap-8 mb-8">
                <div>
                    <div class="flex items-center space-x-2 mb-4">
                        <i class="fa fa-file-text-o text-primary text-2xl"></i>
                        <span class="text-xl font-bold text-white">Kopaper</span>
                    </div>
                    <p class="mb-4">专为大学生打造的论文工具站，让论文写作更简单高效。</p>
                    <div class="flex space-x-4">
                        <a href="#" class="text-gray-400 hover:text-primary transition-colors">
                            <i class="fa fa-weibo text-xl"></i>
                        </a>
                        <a href="#" class="text-gray-400 hover:text-primary transition-colors">
                            <i class="fa fa-wechat text-xl"></i>
                        </a>
                        <a href="#" class="text-gray-400 hover:text-primary transition-colors">
                            <i class="fa fa-github text-xl"></i>
                        </a>
                    </div>
                </div>
                
                <div>
                    <h3 class="text-white font-semibold mb-4">功能导航</h3>
                    <ul class="space-y-2">
                        <li><a href="/compare.html" class="hover:text-primary transition-colors">论文比对</a></li>
                        <li><a href="/check.html" class="hover:text-primary transition-colors">收录查询</a></li>
                        <li><a href="/help.html" class="hover:text-primary transition-colors">使用指南</a></li>
                        <li><a href="/faq.html" class="hover:text-primary transition-colors">常见问题</a></li>
                    </ul>
                </div>
                
                <div>
                    <h3 class="text-white font-semibold mb-4">关于我们</h3>
                    <ul class="space-y-2">
                        <li><a href="/about.html" class="hover:text-primary transition-colors">网站介绍</a></li>
                        <li><a href="/contact.html" class="hover:text-primary transition-colors">联系我们</a></li>
                        <li><a href="/privacy.html" class="hover:text-primary transition-colors">隐私政策</a></li>
                        <li><a href="/terms.html" class="hover:text-primary transition-colors">使用条款</a></li>
                    </ul>
                </div>
                
                <div>
                    <h3 class="text-white font-semibold mb-4">联系我们</h3>
                    <ul class="space-y-2">
                        <li class="flex items-start">
                            <i class="fa fa-envelope-o mt-1 mr-3"></i>
                            <span>support@kopaper.com</span>
                        </li>
                        <li class="flex items-start">
                            <i class="fa fa-question-circle mt-1 mr-3"></i>
                            <span>工作时间: 周一至周五 9:00-18:00</span>
                        </li>
                    </ul>
                </div>
            </div>
            
            <div class="border-t border-gray-800 pt-8 text-center text-sm">
                <p>© 2023 Kopaper.com 版权所有 | 本工具仅用于学术研究辅助，禁止用于学术不端行为</p>
                <p class="mt-2">京ICP备12345678号-1</p>
            </div>
        </div>
    </footer>

    <script>
        // 全局变量存储文件内容
        let fileContent1 = null;
        let fileContent2 = null;
        
        // DOM元素
        const fileModeBtn = document.getElementById('fileModeBtn');
        const textModeBtn = document.getElementById('textModeBtn');
        const fileMode = document.getElementById('fileMode');
        const textMode = document.getElementById('textMode');
        const fileDropzone1 = document.getElementById('fileDropzone1');
        const fileDropzone2 = document.getElementById('fileDropzone2');
        const fileInput1 = document.getElementById('fileInput1');
        const fileInput2 = document.getElementById('fileInput2');
        const fileInfo1 = document.getElementById('fileInfo1');
        const fileInfo2 = document.getElementById('fileInfo2');
        const fileName1 = document.getElementById('fileName1');
        const fileName2 = document.getElementById('fileName2');
        const removeFile1 = document.getElementById('removeFile1');
        const removeFile2 = document.getElementById('removeFile2');
        const originalText = document.getElementById('originalText');
        const modifiedText = document.getElementById('modifiedText');
        const compareBtn = document.getElementById('compareBtn');
        const loadingSection = document.getElementById('loadingSection');
        const resultSection = document.getElementById('resultSection');
        const similarityScore = document.getElementById('similarityScore');
        const totalWords = document.getElementById('totalWords');
        const addedCount = document.getElementById('addedCount');
        const deletedCount = document.getElementById('deletedCount');
        const collapseBtn = document.getElementById('collapseBtn');
        const expandBtn = document.getElementById('expandBtn');
        const exportBtn = document.getElementById('exportBtn');
        const restartBtn = document.getElementById('restartBtn');
        const originalContent = document.getElementById('originalContent');
        const modifiedContent = document.getElementById('modifiedContent');
        const menuToggle = document.getElementById('menu-toggle');
        const mobileMenu = document.getElementById('mobile-menu');
        const navbar = document.getElementById('navbar');
        
        // 初始化diff-match-patch库
        const dmp = new diff_match_patch();
        
        // 移动端菜单切换
        menuToggle.addEventListener('click', function() {
            mobileMenu.classList.toggle('hidden');
        });
        
        // 导航栏滚动效果
        window.addEventListener('scroll', function() {
            if (window.scrollY > 10) {
                navbar.classList.add('shadow');
            } else {
                navbar.classList.remove('shadow');
            }
        });
        
        // 切换比对模式
        fileModeBtn.addEventListener('click', () => {
            fileMode.classList.remove('hidden');
            textMode.classList.add('hidden');
            fileModeBtn.classList.add('text-primary', 'border-primary', 'border-b-2');
            fileModeBtn.classList.remove('text-neutral');
            textModeBtn.classList.remove('text-primary', 'border-primary', 'border-b-2');
            textModeBtn.classList.add('text-neutral');
            updateCompareButtonState();
        });
        
        textModeBtn.addEventListener('click', () => {
            textMode.classList.remove('hidden');
            fileMode.classList.add('hidden');
            textModeBtn.classList.add('text-primary', 'border-primary', 'border-b-2');
            textModeBtn.classList.remove('text-neutral');
            fileModeBtn.classList.remove('text-primary', 'border-primary', 'border-b-2');
            fileModeBtn.classList.add('text-neutral');
            updateCompareButtonState();
        });
        
        // 文件上传相关事件
        fileDropzone1.addEventListener('click', () => fileInput1.click());
        fileDropzone2.addEventListener('click', () => fileInput2.click());
        
        // 拖放功能
        ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
            fileDropzone1.addEventListener(eventName, preventDefaults, false);
            fileDropzone2.addEventListener(eventName, preventDefaults, false);
        });
        
        function preventDefaults(e) {
            e.preventDefault();
            e.stopPropagation();
        }
        
        ['dragenter', 'dragover'].forEach(eventName => {
            fileDropzone1.addEventListener(eventName, highlight, false);
            fileDropzone2.addEventListener(eventName, highlight, false);
        });
        
        ['dragleave', 'drop'].forEach(eventName => {
            fileDropzone1.addEventListener(eventName, unhighlight, false);
            fileDropzone2.addEventListener(eventName, unhighlight, false);
        });
        
        function highlight() {
            this.classList.add('dropzone-active');
        }
        
        function unhighlight() {
            this.classList.remove('dropzone-active');
        }
        
        fileDropzone1.addEventListener('drop', handleDrop1, false);
        fileDropzone2.addEventListener('drop', handleDrop2, false);
        
        function handleDrop1(e) {
            const dt = e.dataTransfer;
            const file = dt.files[0];
            handleFile1(file);
        }
        
        function handleDrop2(e) {
            const dt = e.dataTransfer;
            const file = dt.files[0];
            handleFile2(file);
        }
        
        fileInput1.addEventListener('change', function() {
            if (this.files.length > 0) {
                handleFile1(this.files[0]);
            }
        });
        
        fileInput2.addEventListener('change', function() {
            if (this.files.length > 0) {
                handleFile2(this.files[0]);
            }
        });
        
        // 处理文件
        function handleFile1(file) {
            // 验证文件类型和大小
            if (!file.name.match(/\.(docx|pdf)$/i)) {
                showNotification('请上传.docx或.pdf格式的文件', 'error');
                return;
            }
            
            if (file.size > 20 * 1024 * 1024) {
                showNotification('文件大小不能超过20MB', 'error');
                return;
            }
            
            // 显示文件信息
            fileName1.textContent = file.name;
            fileInfo1.classList.remove('hidden');
            
            // 显示加载中状态
            fileDropzone1.innerHTML = '<div class="flex flex-col items-center justify-center"><div class="w-8 h-8 border-4 border-gray-200 border-t-primary rounded-full animate-spin mb-3"></div><p class="text-neutral">正在解析文件...</p></div>';
            
            // 解析文件内容
            parseFileContent(file, (content) => {
                if (content) {
                    fileContent1 = content;
                    updateCompareButtonState();
                } else {
                    // 解析失败，重置
                    fileContent1 = null;
                    fileInput1.value = '';
                    fileInfo1.classList.add('hidden');
                    resetDropzone1();
                    showNotification('文件解析失败，请尝试其他文件', 'error');
                }
            });
        }
        
        function handleFile2(file) {
            // 验证文件类型和大小
            if (!file.name.match(/\.(docx|pdf)$/i)) {
                showNotification('请上传.docx或.pdf格式的文件', 'error');
                return;
            }
            
            if (file.size > 20 * 1024 * 1024) {
                showNotification('文件大小不能超过20MB', 'error');
                return;
            }
            
            // 显示文件信息
            fileName2.textContent = file.name;
            fileInfo2.classList.remove('hidden');
            
            // 显示加载中状态
            fileDropzone2.innerHTML = '<div class="flex flex-col items-center justify-center"><div class="w-8 h-8 border-4 border-gray-200 border-t-primary rounded-full animate-spin mb-3"></div><p class="text-neutral">正在解析文件...</p></div>';
            
            // 解析文件内容
            parseFileContent(file, (content) => {
                if (content) {
                    fileContent2 = content;
                    updateCompareButtonState();
                } else {
                    // 解析失败，重置
                    fileContent2 = null;
                    fileInput2.value = '';
                    fileInfo2.classList.add('hidden');
                    resetDropzone2();
                    showNotification('文件解析失败，请尝试其他文件', 'error');
                }
            });
        }
        
        // 重置上传区域
        function resetDropzone1() {
            fileDropzone1.innerHTML = `
                <i class="fa fa-file-word-o text-4xl text-neutral mb-3"></i>
                <p class="mb-2 text-neutral">拖放文件到此处，或<span class="text-primary font-medium">点击上传</span></p>
                <p class="text-xs text-gray-400">支持 .docx 或 .pdf 格式（最大20MB）</p>
            `;
        }
        
        function resetDropzone2() {
            fileDropzone2.innerHTML = `
                <i class="fa fa-file-word-o text-4xl text-neutral mb-3"></i>
                <p class="mb-2 text-neutral">拖放文件到此处，或<span class="text-primary font-medium">点击上传</span></p>
                <p class="text-xs text-gray-400">支持 .docx 或 .pdf 格式（最大20MB）</p>
            `;
        }
        
        // 解析文件内容
        function parseFileContent(file, callback) {
            const fileName = file.name;
            
            if (fileName.endsWith('.docx')) {
                // 解析docx文件
                const reader = new FileReader();
                reader.onload = function(e) {
                    const arrayBuffer = e.target.result;
                    mammoth.extractRawText({arrayBuffer: arrayBuffer})
                        .then(function(result) {
                            callback(result.value);
                        })
                        .catch(function(err) {
                            console.error('解析docx文件出错:', err);
                            callback(null);
                        });
                };
                reader.readAsArrayBuffer(file);
            } else if (fileName.endsWith('.pdf')) {
                // 解析pdf文件
                const reader = new FileReader();
                reader.onload = function(e) {
                    const data = new Uint8Array(e.target.result);
                    pdfjsLib.getDocument(data).promise.then(function(pdf) {
                        let textContent = '';
                        const totalPages = pdf.numPages;
                        let countPromises = [];
                        
                        for (let i = 1; i <= totalPages; i++) {
                            countPromises.push(pdf.getPage(i).then(function(page) {
                                return page.getTextContent().then(function(text) {
                                    return text.items.map(item => item.str).join(' ');
                                });
                            }));
                        }
                        
                        Promise.all(countPromises).then(function(texts) {
                            textContent = texts.join('\n\n');
                            callback(textContent);
                        });
                    }).catch(function(err) {
                        console.error('解析pdf文件出错:', err);
                        callback(null);
                    });
                };
                reader.readAsArrayBuffer(file);
            }
        }
        
        // 移除文件
        removeFile1.addEventListener('click', () => {
            fileContent1 = null;
            fileInput1.value = '';
            fileInfo1.classList.add('hidden');
            resetDropzone1();
            updateCompareButtonState();
        });
        
        removeFile2.addEventListener('click', () => {
            fileContent2 = null;
            fileInput2.value = '';
            fileInfo2.classList.add('hidden');
            resetDropzone2();
            updateCompareButtonState();
        });
        
        // 文本区域输入事件
        originalText.addEventListener('input', updateCompareButtonState);
        modifiedText.addEventListener('input', updateCompareButtonState);
        
        // 更新比对按钮状态
        function updateCompareButtonState() {
            let canCompare = false;
            
            if (fileMode.classList.contains('hidden')) {
                // 文本模式
                canCompare = originalText.value.trim() !== '' && modifiedText.value.trim() !== '';
            } else {
                // 文件模式
                canCompare = fileContent1 !== null && fileContent2 !== null;
            }
            
            compareBtn.disabled = !canCompare;
        }
        
        // 开始比对
        compareBtn.addEventListener('click', startComparison);
        
        function startComparison() {
            let text1, text2;
            
            // 获取比对文本
            if (fileMode.classList.contains('hidden')) {
                // 文本模式
                text1 = originalText.value;
                text2 = modifiedText.value;
            } else {
                // 文件模式
                text1 = fileContent1;
                text2 = fileContent2;
            }
            
            // 显示加载状态
            loadingSection.classList.remove('hidden');
            resultSection.classList.add('hidden');
            
            // 延迟执行比对，给用户加载反馈
            setTimeout(() => {
                // 执行比对
                const diffs = dmp.diff_main(text1, text2);
                dmp.diff_cleanupSemantic(diffs);
                
                // 计算统计数据
                calculateStatistics(diffs, text1, text2);
                
                // 渲染比对结果
                renderComparisonResults(diffs);
                
                // 隐藏加载状态，显示结果
                loadingSection.classList.add('hidden');
                resultSection.classList.remove('hidden');
                
                // 滚动到结果区域
                resultSection.scrollIntoView({ behavior: 'smooth' });
                
                // 显示成功通知
                showNotification('比对完成，已显示结果', 'success');
            }, 600);
        }
        
        // 计算统计数据
        function calculateStatistics(diffs, text1, text2) {
            let addedChars = 0;
            let deletedChars = 0;
            let totalChars = text1.length;
            
            // 统计新增和删除的字符数
            diffs.forEach(diff => {
                const [type, content] = diff;
                if (type === 1) { // 新增
                    addedChars += content.length;
                } else if (type === -1) { // 删除
                    deletedChars += content.length;
                }
            });
            
            // 计算相似度 (简化版)
            const similarity = totalChars > 0 
                ? Math.max(0, 100 - (addedChars + deletedChars) / totalChars * 100) 
                : 0;
            
            // 计算总字数 (大致估算)
            const wordCount1 = text1.split(/\s+/).filter(word => word.length > 0).length;
            const wordCount2 = text2.split(/\s+/).filter(word => word.length > 0).length;
            const totalWordCount = Math.max(wordCount1, wordCount2);
            
            // 更新统计数据显示
            similarityScore.textContent = `${Math.round(similarity)}%`;
            totalWords.textContent = totalWordCount;
            addedCount.textContent = Math.round(addedChars / (text2.length / wordCount2 || 1)); // 估算新增字数
            deletedCount.textContent = Math.round(deletedChars / (text1.length / wordCount1 || 1)); // 估算删除字数
        }
        
        // 渲染比对结果
        function renderComparisonResults(diffs) {
            // 清空之前的结果
            originalContent.innerHTML = '';
            modifiedContent.innerHTML = '';
            
            // 创建文档片段提高性能
            const originalFragment = document.createDocumentFragment();
            const modifiedFragment = document.createDocumentFragment();
            
            // 处理每个差异
            diffs.forEach(diff => {
                const [type, content] = diff;
                
                // 处理空内容
                if (!content.trim()) return;
                
                // 将内容按段落分割
                const paragraphs = content.split(/\n+/);
                
                paragraphs.forEach(paragraph => {
                    if (!paragraph.trim()) return;
                    
                    // 创建段落元素
                    const originalPara = document.createElement('p');
                    originalPara.className = 'mb-4 leading-relaxed transition-all';
                    
                    const modifiedPara = document.createElement('p');
                    modifiedPara.className = 'mb-4 leading-relaxed transition-all';
                    
                    // 根据差异类型设置样式
                    switch (type) {
                        case 0: // 相同内容
                            originalPara.textContent = paragraph;
                            modifiedPara.textContent = paragraph;
                            originalPara.classList.add('diff-same');
                            modifiedPara.classList.add('diff-same');
                            break;
                        case 1: // 新增内容 (只在修改版本显示)
                            modifiedPara.innerHTML = `<span class="bg-green-100 text-green-800 px-1 rounded">${escapeHtml(paragraph)}</span>`;
                            modifiedPara.classList.add('diff-added');
                            originalPara.textContent = ''; // 原始版本对应位置为空
                            break;
                        case -1: // 删除内容 (只在原始版本显示)
                            originalPara.innerHTML = `<span class="line-through text-red-600 px-1">${escapeHtml(paragraph)}</span>`;
                            originalPara.classList.add('diff-deleted');
                            modifiedPara.textContent = ''; // 修改版本对应位置为空
                            break;
                    }
                    
                    // 添加到文档片段
                    originalFragment.appendChild(originalPara);
                    modifiedFragment.appendChild(modifiedPara);
                });
            });
            
            // 将文档片段添加到DOM
            originalContent.appendChild(originalFragment);
            modifiedContent.appendChild(modifiedFragment);
            
            // 同步滚动
            syncScroll(originalContent, modifiedContent);
        }
        
        // 同步滚动
        function syncScroll(element1, element2) {
            // 移除之前的事件监听
            element1.removeEventListener('scroll', onScroll1);
            element2.removeEventListener('scroll', onScroll2);
            
            function onScroll1() {
                element2.scrollTop = element1.scrollTop;
                element2.scrollLeft = element1.scrollLeft;
            }
            
            function onScroll2() {
                element1.scrollTop = element2.scrollTop;
                element1.scrollLeft = element2.scrollLeft;
            }
            
            element1.addEventListener('scroll', onScroll1);
            element2.addEventListener('scroll', onScroll2);
        }
        
        // 折叠/展开无差异内容
        collapseBtn.addEventListener('click', () => {
            const paras = originalContent.querySelectorAll('p.diff-same');
            
            paras.forEach((para, index) => {
                const modifiedPara = modifiedContent.querySelectorAll('p.diff-same')[index];
                para.classList.add('hidden');
                modifiedPara.classList.add('hidden');
            });
            
            collapseBtn.classList.add('hidden');
            expandBtn.classList.remove('hidden');
            showNotification('已折叠无差异内容', 'info');
        });
        
        expandBtn.addEventListener('click', () => {
            const paras = originalContent.querySelectorAll('p.diff-same.hidden');
            
            paras.forEach((para, index) => {
                const modifiedPara = modifiedContent.querySelectorAll('p.diff-same.hidden')[index];
                para.classList.remove('hidden');
                modifiedPara.classList.remove('hidden');
            });
            
            expandBtn.classList.add('hidden');
            collapseBtn.classList.remove('hidden');
            showNotification('已展开所有内容', 'info');
        });
        
        // 导出比对报告
        exportBtn.addEventListener('click', () => {
            // 创建一个新窗口用于打印
            const printWindow = window.open('', '_blank');
            
            // 构建导出内容
            const htmlContent = `
                <!DOCTYPE html>
                <html>
                <head>
                    <title>Kopaper论文比对报告</title>
                    <style>
                        body { font-family: Arial, sans-serif; line-height: 1.6; padding: 20px; max-width: 1200px; margin: 0 auto; }
                        h1 { color: #2563EB; text-align: center; }
                        .stats { display: flex; justify-content: space-around; flex-wrap: wrap; margin: 20px 0; padding: 15px; background-color: #f8fafc; border-radius: 8px; }
                        .stat-item { text-align: center; margin: 10px; flex: 1; min-width: 120px; }
                        .stat-value { font-size: 1.5em; font-weight: bold; }
                        .comparison { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-top: 30px; }
                        .column-title { font-weight: bold; padding: 10px; background-color: #e2e8f0; text-align: center; }
                        .content { border: 1px solid #e2e8f0; padding: 15px; min-height: 300px; }
                        .added { background-color: #dcfce7; color: #166534; padding: 0 2px; }
                        .deleted { text-decoration: line-through; color: #dc2626; padding: 0 2px; }
                        p { margin: 0 0 1em 0; }
                        @media print {
                            .comparison { display: block; }
                            .content { margin-bottom: 30px; }
                        }
                    </style>
                </head>
                <body>
                    <h1>论文比对报告</h1>
                    <div class="stats">
                        <div class="stat-item">
                            <div>相似度</div>
                            <div class="stat-value">${similarityScore.textContent}</div>
                        </div>
                        <div class="stat-item">
                            <div>总字数</div>
                            <div class="stat-value">${totalWords.textContent}</div>
                        </div>
                        <div class="stat-item">
                            <div>新增内容</div>
                            <div class="stat-value" style="color: #10B981;">${addedCount.textContent}</div>
                        </div>
                        <div class="stat-item">
                            <div>删除内容</div>
                            <div class="stat-value" style="color: #EF4444;">${deletedCount.textContent}</div>
                        </div>
                    </div>
                    <div class="comparison">
                        <div>
                            <div class="column-title">原始版本</div>
                            <div class="content">${originalContent.innerHTML}</div>
                        </div>
                        <div>
                            <div class="column-title">修改版本</div>
                            <div class="content">${modifiedContent.innerHTML}</div>
                        </div>
                    </div>
                    <div style="margin-top: 30px; font-size: 0.8em; color: #64748B; text-align: center;">
                        报告生成于 ${new Date().toLocaleString()} | 由 Kopaper.com 提供
                    </div>
                </body>
                </html>
            `;
            
            // 写入内容并打印
            printWindow.document.write(htmlContent);
            printWindow.document.close();
            
            // 延迟打印，确保内容加载完成
            setTimeout(() => {
                printWindow.print();
            }, 500);
        });
        
        // 重新比对
        restartBtn.addEventListener('click', () => {
            // 重置表单
            fileContent1 = null;
            fileContent2 = null;
            fileInput1.value = '';
            fileInput2.value = '';
            fileInfo1.classList.add('hidden');
            fileInfo2.classList.add('hidden');
            originalText.value = '';
            modifiedText.value = '';
            resetDropzone1();
            resetDropzone2();
            
            // 隐藏结果，显示输入区域
            resultSection.classList.add('hidden');
            loadingSection.classList.add('hidden');
            
            // 滚动到顶部
            window.scrollTo({ top: 0, behavior: 'smooth' });
            
            // 更新按钮状态
            updateCompareButtonState();
            
            // 显示通知
            showNotification('已重置，可以开始新的比对', 'info');
        });
        
        // 显示通知
        function showNotification(message, type = 'info') {
            // 创建通知元素
            const notification = document.createElement('div');
            notification.className = `fixed bottom-4 right-4 px-4 py-3 rounded-lg shadow-lg z-50 transform transition-all duration-300 translate-y-20 opacity-0`;
            
            // 根据类型设置样式
            switch(type) {
                case 'success':
                    notification.classList.add('bg-green-50', 'text-green-800', 'border-l-4', 'border-green-500');
                    notification.innerHTML = `<div class="flex"><i class="fa fa-check-circle text-green-500 mr-3 mt-0.5"></i><p>${message}</p></div>`;
                    break;
                case 'error':
                    notification.classList.add('bg-red-50', 'text-red-800', 'border-l-4', 'border-red-500');
                    notification.innerHTML = `<div class="flex"><i class="fa fa-times-circle text-red-500 mr-3 mt-0.5"></i><p>${message}</p></div>`;
                    break;
                case 'info':
                default:
                    notification.classList.add('bg-blue-50', 'text-blue-800', 'border-l-4', 'border-blue-500');
                    notification.innerHTML = `<div class="flex"><i class="fa fa-info-circle text-blue-500 mr-3 mt-0.5"></i><p>${message}</p></div>`;
                    break;
            }
            
            // 添加到页面
            document.body.appendChild(notification);
            
            // 显示通知
            setTimeout(() => {
                notification.classList.remove('translate-y-20', 'opacity-0');
            }, 100);
            
            // 3秒后隐藏通知
            setTimeout(() => {
                notification.classList.add('translate-y-20', 'opacity-0');
                setTimeout(() => {
                    document.body.removeChild(notification);
                }, 300);
            }, 3000);
        }
        
        // HTML转义函数
        function escapeHtml(unsafe) {
            return unsafe
                .replace(/&/g, "&amp;")
                .replace(/</g, "&lt;")
                .replace(/>/g, "&gt;")
                .replace(/"/g, "&quot;")
                .replace(/'/g, "&#039;");
        }
        
        // 初始化页面
        updateCompareButtonState();
    </script>
</body>
</html>
    