<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Free Online Paper Compare Tool | Compare Two Papers for Differences</title>
    <meta name="description" content="Our free online paper compare tool helps you easily compare two papers, documents or texts to find differences. Identify changes, additions and deletions instantly - no registration required.">
    <meta name="keywords" content="free online paper compare tool, compare two papers, document comparison">
    
    <!-- External resources -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/diff-match-patch@1.0.5/index.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/mammoth@1.6.0/mammoth.browser.min.js"></script>
    <!-- PDF parsing libraries -->
    <script src="https://cdn.jsdelivr.net/npm/pdf-parse@1.1.1/pdf-parse.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.min.js"></script>
    
    <!-- Tailwind configuration -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#2563EB',
                        secondary: '#10B981',
                        danger: '#EF4444',
                        warning: '#F59E0B',
                        neutral: '#475569',
                        light: '#F8FAFC',
                        dark: '#1E293B',
                        original: '#F9FAFB',
                        modified: '#F0F9FF'
                    },
                    fontFamily: {
                        sans: ['Inter', 'system-ui', 'sans-serif'],
                    },
                }
            }
        }
    </script>
    
    <style type="text/tailwindcss">
        @layer utilities {
            .content-auto {
                content-visibility: auto;
            }
            .text-shadow {
                text-shadow: 0 1px 2px rgba(0,0,0,0.1);
            }
            .transition-height {
                transition: max-height 0.3s ease-in-out;
            }
            .scrollbar-thin {
                scrollbar-width: thin;
            }
            .scrollbar-thin::-webkit-scrollbar {
                width: 6px;
                height: 6px;
            }
            .scrollbar-thin::-webkit-scrollbar-thumb {
                background-color: rgba(71, 85, 105, 0.5);
                border-radius: 3px;
            }
            .dropzone-active {
                @apply border-primary bg-blue-50;
            }
            /* Diff text styles */
            .diff-added {
                @apply bg-green-50;
            }
            .diff-deleted {
                @apply bg-red-50;
            }
            .diff-same {
                @apply text-dark/80;
            }
        }
    </style>
</head>
<body class="bg-light font-sans text-dark min-h-screen flex flex-col">
    <!-- Header navigation -->
    <header class="bg-white shadow-sm sticky top-0 z-50 transition-all duration-300" id="navbar">
        <div class="container mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between items-center h-16">
                <!-- Logo -->
                <div class="flex items-center">
                    <a href="/" class="flex items-center space-x-2">
                        <i class="fa fa-file-text-o text-primary text-2xl"></i>
                        <span class="text-xl font-bold text-primary">KoPaper</span>
                    </a>
                </div>
                
                <!-- Desktop navigation -->
                <nav class="hidden md:flex space-x-8">
                    <a href="/" class="text-neutral hover:text-primary transition-colors flex items-center">
                        <i class="fa fa-home mr-1.5"></i>Home
                    </a>
                    <a href="/compare.html" class="text-primary font-medium flex items-center">
                        <i class="fa fa-exchange mr-1.5"></i>论文比对中文版
                    </a>
                    <a href="/text-compare.html" class="text-neutral hover:text-primary transition-colors flex items-center">
                        <i class="fa fa-exchange mr-1.5"></i>Text Compare
                    </a>
                    <a href="/help.html" class="text-neutral hover:text-primary transition-colors flex items-center">
                        <i class="fa fa-question-circle mr-1.5"></i>Help
                    </a>
                </nav>
                
                <!-- Mobile menu button -->
                <div class="md:hidden">
                    <button id="menu-toggle" class="text-neutral hover:text-primary focus:outline-none">
                        <i class="fa fa-bars text-xl"></i>
                    </button>
                </div>
            </div>
        </div>
        
        <!-- Mobile navigation menu -->
        <div id="mobile-menu" class="hidden md:hidden bg-white border-t">
            <div class="container mx-auto px-4 py-3 space-y-3">
                <a href="/" class="block py-2 text-neutral hover:text-primary transition-colors">
                    <i class="fa fa-home mr-2"></i>Home
                </a>
                <a href="/compare.html" class="block py-2 text-primary font-medium">
                    <i class="fa fa-exchange mr-2"></i>论文比对中文版
                </a>
                <a href="/text-compare.html" class="block py-2 text-neutral hover:text-primary transition-colors">
                    <i class="fa fa-exchange mr-2"></i>Text Compare
                </a>
                <a href="/help.html" class="block py-2 text-neutral hover:text-primary transition-colors">
                    <i class="fa fa-question-circle mr-2"></i>Help
                </a>
            </div>
        </div>
    </header>

    <!-- Main content -->
    <main class="flex-grow container mx-auto px-4 sm:px-6 lg:px-8 py-8">
        <!-- Page title and introduction -->
        <section class="mb-10">
            <div class="flex flex-col md:flex-row md:items-center md:justify-between">
                <div>
                    <h1 class="text-[clamp(1.5rem,3vw,2.5rem)] font-bold mb-2">Free Online Paper Compare Tool</h1>
                    <p class="text-neutral">Quickly compare two papers to find differences. Identify changes, additions and deletions with our easy-to-use tool.</p>
                </div>
                <div class="mt-4 md:mt-0">
                    <a href="/help.html#compare" class="inline-flex items-center text-primary hover:text-primary/80 text-sm font-medium transition-colors">
                        <i class="fa fa-question-circle mr-1.5"></i>View Instructions
                    </a>
                </div>
            </div>
        </section>

        <!-- Security notice -->
        <section class="mb-8">
            <div class="bg-blue-50 border-l-4 border-primary p-4 rounded-r-lg">
                <div class="flex">
                    <div class="flex-shrink-0">
                        <i class="fa fa-lock text-primary"></i>
                    </div>
                    <div class="ml-3">
                        <p class="text-sm text-blue-700">
                            All comparisons are performed locally in your browser. Your documents will never be uploaded to our servers, ensuring complete privacy.
                        </p>
                    </div>
                </div>
            </div>
        </section>

        <!-- Comparison mode selection -->
        <section class="mb-8">
            <div class="bg-white rounded-lg shadow-sm overflow-hidden">
                <div class="flex flex-wrap border-b border-gray-200">
                    <button id="fileModeBtn" class="flex-1 px-6 py-4 font-medium text-primary border-b-2 border-primary transition-all">
                        <i class="fa fa-upload mr-2"></i>Upload Files
                    </button>
                    <button id="textModeBtn" class="flex-1 px-6 py-4 font-medium text-neutral hover:text-primary transition-all">
                        <i class="fa fa-paste mr-2"></i>Paste Text
                    </button>
                </div>
            </div>
        </section>

        <!-- File upload mode -->
        <section id="fileMode" class="mb-10">
            <div class="grid md:grid-cols-2 gap-6">
                <!-- Original version -->
                <div class="bg-white rounded-lg shadow-sm p-6 border border-gray-200 transform hover:shadow-md transition-all">
                    <h3 class="text-lg font-semibold mb-4 flex items-center">
                        <span class="w-2 h-2 rounded-full bg-neutral mr-2"></span>
                        Original Version
                    </h3>
                    <div id="fileDropzone1" class="border-2 border-dashed border-gray-300 rounded-lg p-8 text-center hover:border-primary transition-colors cursor-pointer min-h-[200px] flex flex-col items-center justify-center">
                        <i class="fa fa-file-word-o text-4xl text-neutral mb-3"></i>
                        <p class="mb-2 text-neutral">Drag file here, or <span class="text-primary font-medium">click to upload</span></p>
                        <p class="text-xs text-gray-400">Supports .docx or .pdf (max 20MB)</p>
                        <input type="file" id="fileInput1" class="hidden" accept=".docx,.pdf">
                    </div>
                    <div id="fileInfo1" class="mt-4 hidden">
                        <div class="flex items-center justify-between p-3 bg-light rounded-lg border border-gray-200">
                            <div class="flex items-center overflow-hidden">
                                <i class="fa fa-file-text-o text-primary mr-3 flex-shrink-0"></i>
                                <span id="fileName1" class="truncate"></span>
                            </div>
                            <button id="removeFile1" class="text-neutral hover:text-danger transition-colors p-1">
                                <i class="fa fa-times"></i>
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Modified version -->
                <div class="bg-white rounded-lg shadow-sm p-6 border border-gray-200 transform hover:shadow-md transition-all">
                    <h3 class="text-lg font-semibold mb-4 flex items-center">
                        <span class="w-2 h-2 rounded-full bg-primary mr-2"></span>
                        Modified Version
                    </h3>
                    <div id="fileDropzone2" class="border-2 border-dashed border-gray-300 rounded-lg p-8 text-center hover:border-primary transition-colors cursor-pointer min-h-[200px] flex flex-col items-center justify-center">
                        <i class="fa fa-file-word-o text-4xl text-neutral mb-3"></i>
                        <p class="mb-2 text-neutral">Drag file here, or <span class="text-primary font-medium">click to upload</span></p>
                        <p class="text-xs text-gray-400">Supports .docx or .pdf (max 20MB)</p>
                        <input type="file" id="fileInput2" class="hidden" accept=".docx,.pdf">
                    </div>
                    <div id="fileInfo2" class="mt-4 hidden">
                        <div class="flex items-center justify-between p-3 bg-light rounded-lg border border-gray-200">
                            <div class="flex items-center overflow-hidden">
                                <i class="fa fa-file-text-o text-primary mr-3 flex-shrink-0"></i>
                                <span id="fileName2" class="truncate"></span>
                            </div>
                            <button id="removeFile2" class="text-neutral hover:text-danger transition-colors p-1">
                                <i class="fa fa-times"></i>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- Text paste mode -->
        <section id="textMode" class="mb-10 hidden">
            <div class="grid md:grid-cols-2 gap-6">
                <!-- Original version -->
                <div class="bg-white rounded-lg shadow-sm p-6 border border-gray-200 transform hover:shadow-md transition-all">
                    <h3 class="text-lg font-semibold mb-4 flex items-center">
                        <span class="w-2 h-2 rounded-full bg-neutral mr-2"></span>
                        Original Text
                    </h3>
                    <div>
                        <textarea id="originalText" rows="12" class="w-full p-4 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary/30 focus:border-primary outline-none transition-all resize-none scrollbar-thin" placeholder="Paste original paper content here..."></textarea>
                    </div>
                </div>

                <!-- Modified version -->
                <div class="bg-white rounded-lg shadow-sm p-6 border border-gray-200 transform hover:shadow-md transition-all">
                    <h3 class="text-lg font-semibold mb-4 flex items-center">
                        <span class="w-2 h-2 rounded-full bg-primary mr-2"></span>
                        Modified Text
                    </h3>
                    <div>
                        <textarea id="modifiedText" rows="12" class="w-full p-4 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary/30 focus:border-primary outline-none transition-all resize-none scrollbar-thin" placeholder="Paste modified paper content here..."></textarea>
                    </div>
                </div>
            </div>
        </section>

        <!-- Compare button -->
        <section class="text-center mb-10">
            <button id="compareBtn" class="px-8 py-3 bg-primary hover:bg-primary/90 text-white rounded-lg font-medium shadow-md hover:shadow-lg transition-all disabled:opacity-50 disabled:cursor-not-allowed disabled:hover:shadow-md">
                <i class="fa fa-exchange mr-2"></i>Compare Papers
            </button>
        </section>

        <!-- Loading state -->
        <section id="loadingSection" class="text-center mb-10 hidden">
            <div class="flex flex-col items-center p-8 bg-white rounded-lg shadow-sm">
                <div class="w-12 h-12 border-4 border-gray-200 border-t-primary rounded-full animate-spin mb-4"></div>
                <p class="text-neutral">Comparing documents, please wait...</p>
                <p class="text-sm text-gray-500 mt-2">Larger files may take longer to process</p>
            </div>
        </section>

        <!-- Comparison results -->
        <section id="resultSection" class="mb-10 hidden">
            <!-- Result statistics -->
            <div class="bg-white rounded-lg shadow-sm p-6 mb-6 border border-gray-200">
                <h3 class="text-lg font-semibold mb-6 flex items-center">
                    <i class="fa fa-bar-chart text-primary mr-2"></i>Comparison Results
                </h3>
                <div class="grid grid-cols-2 md:grid-cols-4 gap-4 md:gap-6">
                    <div class="bg-light p-4 rounded-lg text-center border border-gray-200 transform hover:shadow-sm transition-all">
                        <p class="text-neutral text-sm mb-1">Similarity</p>
                        <p id="similarityScore" class="text-2xl font-bold text-primary">0%</p>
                    </div>
                    <div class="bg-light p-4 rounded-lg text-center border border-gray-200 transform hover:shadow-sm transition-all">
                        <p class="text-neutral text-sm mb-1">Total Words</p>
                        <p id="totalWords" class="text-2xl font-bold text-primary">0</p>
                    </div>
                    <div class="bg-light p-4 rounded-lg text-center border border-gray-200 transform hover:shadow-sm transition-all">
                        <p class="text-neutral text-sm mb-1">Added Content</p>
                        <p id="addedCount" class="text-2xl font-bold text-secondary">0</p>
                    </div>
                    <div class="bg-light p-4 rounded-lg text-center border border-gray-200 transform hover:shadow-sm transition-all">
                        <p class="text-neutral text-sm mb-1">Removed Content</p>
                        <p id="deletedCount" class="text-2xl font-bold text-danger">0</p>
                    </div>
                </div>
                <div class="mt-6 flex flex-wrap gap-3">
                    <button id="collapseBtn" class="px-4 py-2 bg-light hover:bg-gray-200 text-neutral rounded-lg text-sm flex items-center transition-colors border border-gray-200">
                        <i class="fa fa-compress mr-2"></i>Hide Identical Content
                    </button>
                    <button id="expandBtn" class="px-4 py-2 bg-light hover:bg-gray-200 text-neutral rounded-lg text-sm flex items-center transition-colors border border-gray-200 hidden">
                        <i class="fa fa-expand mr-2"></i>Show All Content
                    </button>
                    <button id="exportBtn" class="px-4 py-2 bg-light hover:bg-gray-200 text-neutral rounded-lg text-sm flex items-center transition-colors border border-gray-200">
                        <i class="fa fa-download mr-2"></i>Export Report
                    </button>
                    <button id="restartBtn" class="px-4 py-2 bg-light hover:bg-gray-200 text-neutral rounded-lg text-sm flex items-center transition-colors border border-gray-200">
                        <i class="fa fa-refresh mr-2"></i>Compare New Files
                    </button>
                </div>
            </div>

            <!-- Comparison content -->
            <div class="bg-white rounded-lg shadow-sm border border-gray-200 overflow-hidden">
                <div class="grid grid-cols-1 md:grid-cols-2 border-b border-gray-200">
                    <div class="p-4 bg-original font-medium flex items-center">
                        <span class="w-2 h-2 rounded-full bg-neutral mr-2"></span>
                        Original Version
                    </div>
                    <div class="p-4 bg-modified font-medium text-primary flex items-center">
                        <span class="w-2 h-2 rounded-full bg-primary mr-2"></span>
                        Modified Version
                    </div>
                </div>
                <div id="comparisonContent" class="grid grid-cols-1 md:grid-cols-2">
                    <!-- Original content with improved styling -->
                    <div id="originalContent" class="bg-original border-r border-gray-200 p-6 max-h-[600px] overflow-y-auto scrollbar-thin"></div>
                    <!-- Modified content with improved styling -->
                    <div id="modifiedContent" class="bg-modified p-6 max-h-[600px] overflow-y-auto scrollbar-thin"></div>
                </div>
            </div>
        </section>

        <!-- Help tips -->
        <section class="bg-white rounded-lg shadow-sm p-6 mb-10 border border-gray-200">
            <h3 class="text-lg font-semibold mb-4 flex items-center">
                <i class="fa fa-lightbulb-o text-warning mr-2"></i>How to Use
            </h3>
            <ul class="space-y-3 text-neutral">
                <li class="flex items-start">
                    <i class="fa fa-check-circle text-secondary mt-1 mr-3"></i>
                    <span>Green highlighted sections indicate added content, while strikethrough text shows removed content</span>
                </li>
                <li class="flex items-start">
                    <i class="fa fa-check-circle text-secondary mt-1 mr-3"></i>
                    <span>Similarity percentage is for reference only and not equivalent to plagiarism checking</span>
                </li>
                <li class="flex items-start">
                    <i class="fa fa-check-circle text-secondary mt-1 mr-3"></i>
                    <span>Complex formatting (equations, charts) may affect comparison accuracy - plain text is recommended</span>
                </li>
                <li class="flex items-start">
                    <i class="fa fa-check-circle text-secondary mt-1 mr-3"></i>
                    <span>All operations are performed locally in your browser to ensure document security</span>
                </li>
            </ul>
        </section>
    </main>

    <!-- Footer -->
    <footer class="bg-dark text-gray-400 py-12">
        <div class="container mx-auto px-4 sm:px-6 lg:px-8">
            <div class="grid grid-cols-1 md:grid-cols-4 gap-8 mb-8">
                <div>
                    <div class="flex items-center space-x-2 mb-4">
                        <i class="fa fa-file-text-o text-primary text-2xl"></i>
                        <span class="text-xl font-bold text-white">PaperCompare</span>
                    </div>
                    <p class="mb-4">Free online tools for academic writing. Make paper comparison simple and efficient.</p>
                    <div class="flex space-x-4">
                        <a href="#" class="text-gray-400 hover:text-primary transition-colors">
                            <i class="fa fa-twitter text-xl"></i>
                        </a>
                        <a href="#" class="text-gray-400 hover:text-primary transition-colors">
                            <i class="fa fa-facebook text-xl"></i>
                        </a>
                        <a href="#" class="text-gray-400 hover:text-primary transition-colors">
                            <i class="fa fa-github text-xl"></i>
                        </a>
                    </div>
                </div>
                
                <div>
                    <h3 class="text-white font-semibold mb-4">Tools</h3>
                    <ul class="space-y-2">
                        <li><a href="/compare.html" class="hover:text-primary transition-colors">Paper Comparison</a></li>
                        <li><a href="/checker.html" class="hover:text-primary transition-colors">Plagiarism Checker</a></li>
                        <li><a href="/wordcount.html" class="hover:text-primary transition-colors">Word Counter</a></li>
                        <li><a href="/formatter.html" class="hover:text-primary transition-colors">Text Formatter</a></li>
                    </ul>
                </div>
                
                <div>
                    <h3 class="text-white font-semibold mb-4">About</h3>
                    <ul class="space-y-2">
                        <li><a href="/about.html" class="hover:text-primary transition-colors">About Us</a></li>
                        <li><a href="/contact.html" class="hover:text-primary transition-colors">Contact</a></li>
                        <li><a href="/privacy.html" class="hover:text-primary transition-colors">Privacy Policy</a></li>
                        <li><a href="/terms.html" class="hover:text-primary transition-colors">Terms of Service</a></li>
                    </ul>
                </div>
                
                <div>
                    <h3 class="text-white font-semibold mb-4">Support</h3>
                    <ul class="space-y-2">
                        <li class="flex items-start">
                            <i class="fa fa-envelope-o mt-1 mr-3"></i>
                            <span>support@KoPaper.com</span>
                        </li>
                        <li class="flex items-start">
                            <i class="fa fa-question-circle mt-1 mr-3"></i>
                            <span>Working hours: Mon-Fri 9:00-18:00 GMT</span>
                        </li>
                    </ul>
                </div>
            </div>
            
            <div class="border-t border-gray-800 pt-8 text-center text-sm">
                <p>© 2025 KoPaper.com | Free online paper comparison tool for academic use</p>
                <p class="mt-2">Use our tools responsibly and in accordance with academic integrity policies</p>
            </div>
        </div>
    </footer>

    <script>
        // Global variables to store file contents
        let fileContent1 = null;
        let fileContent2 = null;
        
        // DOM elements
        const fileModeBtn = document.getElementById('fileModeBtn');
        const textModeBtn = document.getElementById('textModeBtn');
        const fileMode = document.getElementById('fileMode');
        const textMode = document.getElementById('textMode');
        const fileDropzone1 = document.getElementById('fileDropzone1');
        const fileDropzone2 = document.getElementById('fileDropzone2');
        const fileInput1 = document.getElementById('fileInput1');
        const fileInput2 = document.getElementById('fileInput2');
        const fileInfo1 = document.getElementById('fileInfo1');
        const fileInfo2 = document.getElementById('fileInfo2');
        const fileName1 = document.getElementById('fileName1');
        const fileName2 = document.getElementById('fileName2');
        const removeFile1 = document.getElementById('removeFile1');
        const removeFile2 = document.getElementById('removeFile2');
        const originalText = document.getElementById('originalText');
        const modifiedText = document.getElementById('modifiedText');
        const compareBtn = document.getElementById('compareBtn');
        const loadingSection = document.getElementById('loadingSection');
        const resultSection = document.getElementById('resultSection');
        const similarityScore = document.getElementById('similarityScore');
        const totalWords = document.getElementById('totalWords');
        const addedCount = document.getElementById('addedCount');
        const deletedCount = document.getElementById('deletedCount');
        const collapseBtn = document.getElementById('collapseBtn');
        const expandBtn = document.getElementById('expandBtn');
        const exportBtn = document.getElementById('exportBtn');
        const restartBtn = document.getElementById('restartBtn');
        const originalContent = document.getElementById('originalContent');
        const modifiedContent = document.getElementById('modifiedContent');
        const menuToggle = document.getElementById('menu-toggle');
        const mobileMenu = document.getElementById('mobile-menu');
        const navbar = document.getElementById('navbar');
        
        // Initialize diff-match-patch library
        const dmp = new diff_match_patch();
        
        // Mobile menu toggle
        menuToggle.addEventListener('click', function() {
            mobileMenu.classList.toggle('hidden');
        });
        
        // Navbar scroll effect
        window.addEventListener('scroll', function() {
            if (window.scrollY > 10) {
                navbar.classList.add('shadow');
            } else {
                navbar.classList.remove('shadow');
            }
        });
        
        // Switch comparison modes
        fileModeBtn.addEventListener('click', () => {
            fileMode.classList.remove('hidden');
            textMode.classList.add('hidden');
            fileModeBtn.classList.add('text-primary', 'border-primary', 'border-b-2');
            fileModeBtn.classList.remove('text-neutral');
            textModeBtn.classList.remove('text-primary', 'border-primary', 'border-b-2');
            textModeBtn.classList.add('text-neutral');
            updateCompareButtonState();
        });
        
        textModeBtn.addEventListener('click', () => {
            textMode.classList.remove('hidden');
            fileMode.classList.add('hidden');
            textModeBtn.classList.add('text-primary', 'border-primary', 'border-b-2');
            textModeBtn.classList.remove('text-neutral');
            fileModeBtn.classList.remove('text-primary', 'border-primary', 'border-b-2');
            fileModeBtn.classList.add('text-neutral');
            updateCompareButtonState();
        });
        
        // File upload events
        fileDropzone1.addEventListener('click', () => fileInput1.click());
        fileDropzone2.addEventListener('click', () => fileInput2.click());
        
        // Drag and drop functionality
        ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
            fileDropzone1.addEventListener(eventName, preventDefaults, false);
            fileDropzone2.addEventListener(eventName, preventDefaults, false);
        });
        
        function preventDefaults(e) {
            e.preventDefault();
            e.stopPropagation();
        }
        
        ['dragenter', 'dragover'].forEach(eventName => {
            fileDropzone1.addEventListener(eventName, highlight, false);
            fileDropzone2.addEventListener(eventName, highlight, false);
        });
        
        ['dragleave', 'drop'].forEach(eventName => {
            fileDropzone1.addEventListener(eventName, unhighlight, false);
            fileDropzone2.addEventListener(eventName, unhighlight, false);
        });
        
        function highlight() {
            this.classList.add('dropzone-active');
        }
        
        function unhighlight() {
            this.classList.remove('dropzone-active');
        }
        
        fileDropzone1.addEventListener('drop', handleDrop1, false);
        fileDropzone2.addEventListener('drop', handleDrop2, false);
        
        function handleDrop1(e) {
            const dt = e.dataTransfer;
            const file = dt.files[0];
            handleFile1(file);
        }
        
        function handleDrop2(e) {
            const dt = e.dataTransfer;
            const file = dt.files[0];
            handleFile2(file);
        }
        
        fileInput1.addEventListener('change', function() {
            if (this.files.length > 0) {
                handleFile1(this.files[0]);
            }
        });
        
        fileInput2.addEventListener('change', function() {
            if (this.files.length > 0) {
                handleFile2(this.files[0]);
            }
        });
        
        // Handle successful file1 parsing
        function handleFile1Success(file) {
            // Restore upload area display
            resetDropzone1();
            
            // Show file information
            fileName1.textContent = file.name;
            fileInfo1.classList.remove('hidden');
            
            // Show success notification
            showNotification(`File "${file.name}" parsed successfully`, 'success');
        }
        
        // Handle successful file2 parsing
        function handleFile2Success(file) {
            // Restore upload area display
            resetDropzone2();
            
            // Show file information
            fileName2.textContent = file.name;
            fileInfo2.classList.remove('hidden');
            
            // Show success notification
            showNotification(`File "${file.name}" parsed successfully`, 'success');
        }
        
        // Process files
        function handleFile1(file) {
            // Validate file type and size
            if (!file.name.match(/\.(docx|pdf)$/i)) {
                showNotification('Please upload .docx or .pdf files only', 'error');
                return;
            }
            
            if (file.size > 20 * 1024 * 1024) {
                showNotification('File size cannot exceed 20MB', 'error');
                return;
            }
            
            // Show loading state
            fileDropzone1.innerHTML = '<div class="flex flex-col items-center justify-center"><div class="w-8 h-8 border-4 border-gray-200 border-t-primary rounded-full animate-spin mb-3"></div><p class="text-neutral">Processing file...</p></div>';
            
            // Parse file content
            parseFileContent(file, (content) => {
                if (content) {
                    fileContent1 = content;
                    handleFile1Success(file);
                    updateCompareButtonState();
                } else {
                    // Parsing failed, reset
                    fileContent1 = null;
                    fileInput1.value = '';
                    fileInfo1.classList.add('hidden');
                    resetDropzone1();
                    showNotification('Failed to parse file. Please try another file.', 'error');
                }
            });
        }
        
        function handleFile2(file) {
            // Validate file type and size
            if (!file.name.match(/\.(docx|pdf)$/i)) {
                showNotification('Please upload .docx or .pdf files only', 'error');
                return;
            }
            
            if (file.size > 20 * 1024 * 1024) {
                showNotification('File size cannot exceed 20MB', 'error');
                return;
            }
            
            // Show loading state
            fileDropzone2.innerHTML = '<div class="flex flex-col items-center justify-center"><div class="w-8 h-8 border-4 border-gray-200 border-t-primary rounded-full animate-spin mb-3"></div><p class="text-neutral">Processing file...</p></div>';
            
            // Parse file content
            parseFileContent(file, (content) => {
                if (content) {
                    fileContent2 = content;
                    handleFile2Success(file);
                    updateCompareButtonState();
                } else {
                    // Parsing failed, reset
                    fileContent2 = null;
                    fileInput2.value = '';
                    fileInfo2.classList.add('hidden');
                    resetDropzone2();
                    showNotification('Failed to parse file. Please try another file.', 'error');
                }
            });
        }
        
        // Reset upload areas
        function resetDropzone1() {
            fileDropzone1.innerHTML = `
                <i class="fa fa-file-word-o text-4xl text-neutral mb-3"></i>
                <p class="mb-2 text-neutral">Drag file here, or <span class="text-primary font-medium">click to upload</span></p>
                <p class="text-xs text-gray-400">Supports .docx or .pdf (max 20MB)</p>
            `;
        }
        
        function resetDropzone2() {
            fileDropzone2.innerHTML = `
                <i class="fa fa-file-word-o text-4xl text-neutral mb-3"></i>
                <p class="mb-2 text-neutral">Drag file here, or <span class="text-primary font-medium">click to upload</span></p>
                <p class="text-xs text-gray-400">Supports .docx or .pdf (max 20MB)</p>
            `;
        }
        
        // Parse file content
        function parseFileContent(file, callback) {
            const fileName = file.name;
            
            if (fileName.endsWith('.docx')) {
                // Parse docx files
                const reader = new FileReader();
                reader.onload = function(e) {
                    const arrayBuffer = e.target.result;
                    mammoth.extractRawText({arrayBuffer: arrayBuffer})
                        .then(function(result) {
                            callback(result.value);
                        })
                        .catch(function(err) {
                            console.error('Error parsing docx file:', err);
                            callback(null);
                        });
                };
                reader.readAsArrayBuffer(file);
            } else if (fileName.endsWith('.pdf')) {
                // Parse pdf files
                const reader = new FileReader();
                reader.onload = function(e) {
                    const data = new Uint8Array(e.target.result);
                    
                    // Try pdf-parse first
                    try {
                        pdfParse(data).then(function(result) {
                            callback(result.text);
                        }).catch(function(err) {
                            console.error('pdf-parse failed, trying pdf.js:', err);
                            parsePdfWithPdfJs(data, callback);
                        });
                    } catch (err) {
                        console.error('pdf-parse initialization failed, using pdf.js:', err);
                        parsePdfWithPdfJs(data, callback);
                    }
                };
                reader.readAsArrayBuffer(file);
            }
        }
        
        // Parse PDF with pdf.js as fallback
        function parsePdfWithPdfJs(data, callback) {
            try {
                pdfjsLib.getDocument({data: data}).promise.then(function(pdf) {
                    let textContent = '';
                    const totalPages = pdf.numPages;
                    let countPromises = [];
                    
                    for (let i = 1; i <= totalPages; i++) {
                        countPromises.push(pdf.getPage(i).then(function(page) {
                            return page.getTextContent().then(function(text) {
                                return text.items.map(item => item.str).join(' ');
                            });
                        }));
                    }
                    
                    Promise.all(countPromises).then(function(texts) {
                        textContent = texts.join('\n\n');
                        callback(textContent);
                    });
                }).catch(function(err) {
                    console.error('pdf.js parsing failed:', err);
                    callback(null);
                });
            } catch (err) {
                console.error('pdf.js initialization failed:', err);
                callback(null);
            }
        }
        
        // Remove files
        removeFile1.addEventListener('click', () => {
            fileContent1 = null;
            fileInput1.value = '';
            fileInfo1.classList.add('hidden');
            resetDropzone1();
            updateCompareButtonState();
        });
        
        removeFile2.addEventListener('click', () => {
            fileContent2 = null;
            fileInput2.value = '';
            fileInfo2.classList.add('hidden');
            resetDropzone2();
            updateCompareButtonState();
        });
        
        // Text area input events
        originalText.addEventListener('input', updateCompareButtonState);
        modifiedText.addEventListener('input', updateCompareButtonState);
        
        // Update compare button state
        function updateCompareButtonState() {
            let canCompare = false;
            
            if (fileMode.classList.contains('hidden')) {
                // Text mode
                canCompare = originalText.value.trim() !== '' && modifiedText.value.trim() !== '';
            } else {
                // File mode
                canCompare = fileContent1 !== null && fileContent2 !== null;
            }
            
            compareBtn.disabled = !canCompare;
        }
        
        // Word counting function
        function countWords(text) {
            if (!text) return 0;
            
            // Split on whitespace and count non-empty tokens
            return text.split(/\s+/).filter(word => word.length > 0).length;
        }
        
        // Character counting for statistics
        function countChars(text) {
            return text ? text.length : 0;
        }
        
        // Start comparison
        compareBtn.addEventListener('click', startComparison);
        
        function startComparison() {
            let text1, text2;
            
            // Get comparison texts
            if (fileMode.classList.contains('hidden')) {
                // Text mode
                text1 = originalText.value;
                text2 = modifiedText.value;
            } else {
                // File mode
                text1 = fileContent1;
                text2 = fileContent2;
            }
            
            // Show loading state
            loadingSection.classList.remove('hidden');
            resultSection.classList.add('hidden');
            
            // Add delay for better UX
            setTimeout(() => {
                // Perform comparison
                const diffs = dmp.diff_main(text1, text2);
                dmp.diff_cleanupSemantic(diffs);
                
                // Calculate statistics
                calculateStatistics(diffs, text1, text2);
                
                // Render results
                renderComparisonResults(diffs);
                
                // Hide loading, show results
                loadingSection.classList.add('hidden');
                resultSection.classList.remove('hidden');
                
                // Scroll to results
                resultSection.scrollIntoView({ behavior: 'smooth' });
                
                // Show notification
                showNotification('Comparison complete. Results displayed below.', 'success');
            }, 600);
        }
        
        // Calculate comparison statistics
        function calculateStatistics(diffs, text1, text2) {
            let addedChars = 0;
            let deletedChars = 0;
            let addedWords = 0;
            let deletedWords = 0;
            
            // Count additions and deletions
            diffs.forEach(diff => {
                const [type, content] = diff;
                if (type === 1) { // Added
                    addedChars += countChars(content);
                    addedWords += countWords(content);
                } else if (type === -1) { // Deleted
                    deletedChars += countChars(content);
                    deletedWords += countWords(content);
                }
            });
            
            // Calculate similarity percentage
            const totalChars1 = countChars(text1);
            const similarity = totalChars1 > 0 
                ? Math.max(0, 100 - (addedChars + deletedChars) / totalChars1 * 100) 
                : 0;
            
            // Total words (max of both documents)
            const totalWordCount1 = countWords(text1);
            const totalWordCount2 = countWords(text2);
            const totalWordCount = Math.max(totalWordCount1, totalWordCount2);
            
            // Update statistics display
            similarityScore.textContent = `${Math.round(similarity)}%`;
            totalWords.textContent = totalWordCount;
            addedCount.textContent = addedWords;
            deletedCount.textContent = deletedWords;
        }
        
        // Render comparison results
        function renderComparisonResults(diffs) {
            // Clear previous results
            originalContent.innerHTML = '';
            modifiedContent.innerHTML = '';
            
            // Create document fragments for better performance
            const originalFragment = document.createDocumentFragment();
            const modifiedFragment = document.createDocumentFragment();
            
            // Process each difference
            diffs.forEach(diff => {
                const [type, content] = diff;
                
                // Skip empty content
                if (!content.trim()) return;
                
                // Split content into paragraphs
                const paragraphs = content.split(/\n+/);
                
                paragraphs.forEach(paragraph => {
                    if (!paragraph.trim()) return;
                    
                    // Create paragraph elements
                    const originalPara = document.createElement('p');
                    originalPara.className = 'mb-4 leading-relaxed transition-all p-2 rounded';
                    
                    const modifiedPara = document.createElement('p');
                    modifiedPara.className = 'mb-4 leading-relaxed transition-all p-2 rounded';
                    
                    // Apply styles based on difference type
                    switch (type) {
                        case 0: // Identical content
                            originalPara.textContent = paragraph;
                            modifiedPara.textContent = paragraph;
                            originalPara.classList.add('diff-same');
                            modifiedPara.classList.add('diff-same');
                            break;
                        case 1: // Added content (only in modified version)
                            modifiedPara.innerHTML = `<span class="bg-green-100 text-green-800 px-1 rounded">${escapeHtml(paragraph)}</span>`;
                            modifiedPara.classList.add('diff-added');
                            originalPara.textContent = ''; // Empty in original
                            break;
                        case -1: // Deleted content (only in original version)
                            originalPara.innerHTML = `<span class="line-through text-red-600 px-1">${escapeHtml(paragraph)}</span>`;
                            originalPara.classList.add('diff-deleted');
                            modifiedPara.textContent = ''; // Empty in modified
                            break;
                    }
                    
                    // Add to fragments
                    originalFragment.appendChild(originalPara);
                    modifiedFragment.appendChild(modifiedPara);
                });
            });
            
            // Add fragments to DOM
            originalContent.appendChild(originalFragment);
            modifiedContent.appendChild(modifiedFragment);
            
            // Sync scrolling between panels
            syncScroll(originalContent, modifiedContent);
        }
        
        // Synchronize scrolling between elements
        function syncScroll(element1, element2) {
            // Remove previous listeners
            element1.removeEventListener('scroll', onScroll1);
            element2.removeEventListener('scroll', onScroll2);
            
            function onScroll1() {
                element2.scrollTop = element1.scrollTop;
                element2.scrollLeft = element1.scrollLeft;
            }
            
            function onScroll2() {
                element1.scrollTop = element2.scrollTop;
                element1.scrollLeft = element2.scrollLeft;
            }
            
            element1.addEventListener('scroll', onScroll1);
            element2.addEventListener('scroll', onScroll2);
        }
        
        // Collapse/expand identical content
        collapseBtn.addEventListener('click', () => {
            const paras = originalContent.querySelectorAll('p.diff-same');
            
            paras.forEach((para, index) => {
                const modifiedPara = modifiedContent.querySelectorAll('p.diff-same')[index];
                para.classList.add('hidden');
                modifiedPara.classList.add('hidden');
            });
            
            collapseBtn.classList.add('hidden');
            expandBtn.classList.remove('hidden');
            showNotification('Identical content has been hidden', 'info');
        });
        
        expandBtn.addEventListener('click', () => {
            const paras = originalContent.querySelectorAll('p.diff-same.hidden');
            
            paras.forEach((para, index) => {
                const modifiedPara = modifiedContent.querySelectorAll('p.diff-same.hidden')[index];
                para.classList.remove('hidden');
                modifiedPara.classList.remove('hidden');
            });
            
            expandBtn.classList.add('hidden');
            collapseBtn.classList.remove('hidden');
            showNotification('All content is now visible', 'info');
        });
        
        // Export comparison report
        exportBtn.addEventListener('click', () => {
            // Create new window for printing
            const printWindow = window.open('', '_blank');
            
            // Build export content
            const htmlContent = `
                <!DOCTYPE html>
                <html>
                <head>
                    <title>Paper Comparison Report</title>
                    <style>
                        body { font-family: Arial, sans-serif; line-height: 1.6; padding: 20px; max-width: 1200px; margin: 0 auto; }
                        h1 { color: #2563EB; text-align: center; }
                        .stats { display: flex; justify-content: space-around; flex-wrap: wrap; margin: 20px 0; padding: 15px; background-color: #f8fafc; border-radius: 8px; }
                        .stat-item { text-align: center; margin: 10px; flex: 1; min-width: 120px; }
                        .stat-value { font-size: 1.5em; font-weight: bold; }
                        .comparison { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-top: 30px; }
                        .column-title { font-weight: bold; padding: 10px; background-color: #e2e8f0; text-align: center; }
                        .content { border: 1px solid #e2e8f0; padding: 15px; min-height: 300px; }
                        .original-content { background-color: #F9FAFB; }
                        .modified-content { background-color: #F0F9FF; }
                        .added { background-color: #dcfce7; color: #166534; padding: 0 2px; }
                        .deleted { text-decoration: line-through; color: #dc2626; padding: 0 2px; }
                        p { margin: 0 0 1em 0; padding: 4px; }
                        @media print {
                            .comparison { display: block; }
                            .content { margin-bottom: 30px; }
                        }
                    </style>
                </head>
                <body>
                    <h1>Paper Comparison Report</h1>
                    <div class="stats">
                        <div class="stat-item">
                            <div>Similarity</div>
                            <div class="stat-value">${similarityScore.textContent}</div>
                        </div>
                        <div class="stat-item">
                            <div>Total Words</div>
                            <div class="stat-value">${totalWords.textContent}</div>
                        </div>
                        <div class="stat-item">
                            <div>Added Content</div>
                            <div class="stat-value" style="color: #10B981;">${addedCount.textContent}</div>
                        </div>
                        <div class="stat-item">
                            <div>Removed Content</div>
                            <div class="stat-value" style="color: #EF4444;">${deletedCount.textContent}</div>
                        </div>
                    </div>
                    <div class="comparison">
                        <div>
                            <div class="column-title">Original Version</div>
                            <div class="content original-content">${originalContent.innerHTML}</div>
                        </div>
                        <div>
                            <div class="column-title">Modified Version</div>
                            <div class="content modified-content">${modifiedContent.innerHTML}</div>
                        </div>
                    </div>
                    <div style="margin-top: 30px; font-size: 0.8em; color: #64748B; text-align: center;">
                        Report generated on ${new Date().toLocaleString()} | Generated with KoPaper.com
                    </div>
                </body>
                </html>
            `;
            
            // Write content and print
            printWindow.document.write(htmlContent);
            printWindow.document.close();
            
            // Delay printing to ensure content loads
            setTimeout(() => {
                printWindow.print();
            }, 500);
        });
        
        // Restart comparison
        restartBtn.addEventListener('click', () => {
            // Reset form
            fileContent1 = null;
            fileContent2 = null;
            fileInput1.value = '';
            fileInput2.value = '';
            fileInfo1.classList.add('hidden');
            fileInfo2.classList.add('hidden');
            originalText.value = '';
            modifiedText.value = '';
            resetDropzone1();
            resetDropzone2();
            
            // Hide results, show input area
            resultSection.classList.add('hidden');
            loadingSection.classList.add('hidden');
            
            // Scroll to top
            window.scrollTo({ top: 0, behavior: 'smooth' });
            
            // Update button state
            updateCompareButtonState();
            
            // Show notification
            showNotification('Ready to start a new comparison', 'info');
        });
        
        // Show notifications
        function showNotification(message, type = 'info') {
            // Create notification element
            const notification = document.createElement('div');
            notification.className = `fixed bottom-4 right-4 px-4 py-3 rounded-lg shadow-lg z-50 transform transition-all duration-300 translate-y-20 opacity-0`;
            
            // Apply styling based on type
            switch(type) {
                case 'success':
                    notification.classList.add('bg-green-50', 'text-green-800', 'border-l-4', 'border-green-500');
                    notification.innerHTML = `<div class="flex"><i class="fa fa-check-circle text-green-500 mr-3 mt-0.5"></i><p>${message}</p></div>`;
                    break;
                case 'error':
                    notification.classList.add('bg-red-50', 'text-red-800', 'border-l-4', 'border-red-500');
                    notification.innerHTML = `<div class="flex"><i class="fa fa-times-circle text-red-500 mr-3 mt-0.5"></i><p>${message}</p></div>`;
                    break;
                case 'info':
                default:
                    notification.classList.add('bg-blue-50', 'text-blue-800', 'border-l-4', 'border-blue-500');
                    notification.innerHTML = `<div class="flex"><i class="fa fa-info-circle text-blue-500 mr-3 mt-0.5"></i><p>${message}</p></div>`;
                    break;
            }
            
            // Add to page
            document.body.appendChild(notification);
            
            // Show notification with animation
            setTimeout(() => {
                notification.classList.remove('translate-y-20', 'opacity-0');
            }, 100);
            
            // Hide notification after 3 seconds
            setTimeout(() => {
                notification.classList.add('translate-y-20', 'opacity-0');
                setTimeout(() => {
                    document.body.removeChild(notification);
                }, 300);
            }, 3000);
        }
        
        // HTML escape function
        function escapeHtml(unsafe) {
            return unsafe
                .replace(/&/g, "&amp;")
                .replace(/</g, "&lt;")
                .replace(/>/g, "&gt;")
                .replace(/"/g, "&quot;")
                .replace(/'/g, "&#039;");
        }
        
        // Initialize page
        updateCompareButtonState();
    </script>
</body>
</html>
